<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>metroscreener - all data</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <h3>Das ist die vollständige Liste aller Waren, die aktuellen Angebote gibts <a href="index.html">hier</a>!</h3>
    <table>
        <thead style="position: sticky; top: 0; z-index: 1;">
            <tr style="background-color: white;">
                <th id="status" width="140px" height="30px"></th>
                <th></th>
                <th style="text-align: left;">
                    <input type="text" size="60" placeholder="Nach Beschreibung Suchen">
                </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</body>
    <script>
function row_to_html_string(row) {
    var key = row.key;
    var url_from_key = key.slice(0, -8) + '/' + key.slice(-8,-4) + '/' + key.slice(-4)
    var name = '<td><a href="https://produkte.metro.de/shop/pv/' + url_from_key + '" target="_blank">' + row.name + '</a></td>';
    var cat = '<td style="text-align:center;">' + row.category.split('/').slice(-1) + '</td>'
    var price = '<td style="text-align:right;">' + row[Object.keys(row).slice(-2, -1)] + ' EUR</td>';

    return price+cat+name;
}

d3.select('#status').text('Lade Daten...')
var total_count = 0;
d3.tsv('history.csv').then((data) => {
    d3.select('tbody')
      .selectAll('tr')
      .data(data)
      .enter()
      .append('tr')
      .style('visibility', 'visible')
      .attr('name', (row) => {return row.name;})
      .html(row_to_html_string)
      .transition()
      .on('end', (_, i) => {
        total_count = Math.max(total_count, i);
        d3.select('#status').text(total_count + ' Einträge')
      });
});

var timer = null;
d3.select('input').on('input', (e) => {
    clearTimeout(timer);
    timer = setTimeout(function () {
        d3.select('#status').text('Lade Daten...')
        d3.select('tbody').style('visibility', 'collapse');
        d3.select('input').attr('disabled', true);

        var visibles = 0;
        d3.select('tbody')
          .selectAll('tr')
          .transition()
          .style('visibility', (tr) => {
            if (tr.name.toLowerCase().includes(d3.select('input').property('value').toLowerCase())) {
                visibles += 1; // is that atomic?
                return 'visible';
            } else {
                return 'collapse';
            }
          })
          .on('end', (tr, i) => {
            if (i == total_count) {
                d3.select('tbody').style('visibility', 'visible');
                d3.select('input').attr('disabled', null);
                d3.select('#status').text(visibles + ' Einträge')
            }
          });

    }, 400);
});


    </script>
</html>