<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>metroscreener - all data</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/nextapps-de/flexsearch@0.7.31/dist/flexsearch.light.js"></script>
</head>
<body>
    <h3>Das ist die vollst채ndige Liste aller Waren, die aktuellen Angebote gibts <a href="index.html">hier</a>!</h3>
    <table>
        <thead style="position: sticky; top: 0; z-index: 1;">
            <tr style="background-color: white;">
                <th id="status" width="140px" height="30px" ></th>
                <th style="text-align: left;" colspan="2">
                    <input type="text" size="100%" placeholder="Nach Beschreibung Suchen">
                </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</body>
    <script>
var index = new FlexSearch.Index({tokenize:'full'});
var total_count = 0;

function row_to_html_string(row, i) {
    var key = row.key;
    var url_from_key = key.slice(0, -8) + '/' + key.slice(-8,-4) + '/' + key.slice(-4)
    var name = '<td><a href="https://produkte.metro.de/shop/pv/' + url_from_key + '" target="_blank">' + row.name + '</a></td>';
    var cat = '<td style="text-align:center;">' + row.category.split('/').slice(-1) + '</td>'
    var price = '<td style="text-align:right;">' + row[Object.keys(row).slice(-2, -1)] + ' EUR</td>';

    index.add(i, row.name);
    index.add(i, row.category);
    total_count = Math.max(total_count, i);
    d3.select('#status').text(total_count + ' Eintr채ge')

    return price+cat+name;
}

d3.select('#status').text('Lade Daten...')

d3.tsv('history.csv').then((data) => {
    d3.select('tbody')
      .selectAll('tr')
      .data(data)
      .enter()
      .append('tr')
      .attr('id', (row, i) => {return i;})
      .html(row_to_html_string);
});

var timer = null;
d3.select('input').on('input', (e) => {
    var value = d3.select('input').property('value');
    if (value.length == 0) {
        d3.select('tbody')
          .selectAll('tr')
          .style('display', null);

        d3.select('#status').text(total_count + ' Eintr채ge')

        return;
    }

    d3.select('tbody')
      .selectAll('tr')
      .style('display', 'none');

    matches = index.search(value)
    matches.forEach( i => {document.getElementById(i).style.display = null});

    d3.select('#status').text(matches.length + ' Eintr채ge')
});


    </script>
</html>