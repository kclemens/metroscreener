<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>metroscreener - current highlights</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <table>
        <thead style="position: sticky; top: 0; z-index: 1;">
            <tr style="background-color: white;">
                <th id="status" width="140px" height="30px"></th>
                <th style="text-align: left;">
                    <input type="text" size="60" placeholder="Nach Beschreibung Suchen">
                    dies sind die besten Angebote, 
                    <a href="all.html">hier</a>
                    gehts zu allen Artikeln.
                </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</body>
    <script>
var price_key = 'offer-' + new Date().toISOString().split('T')[0]


function row_to_html_string(row) {
    if (row[price_key]) {
        var name = '<td><a href="https://produkte.metro.de/shop/pv/' + row.key + '" target="_blank">' + row.name + '</a></td>';
        var price = '<td style="text-align:center;">' + row[price_key] + ' EUR</td>';
        return price+name;
    }
    return null;
}

d3.select('#status').text('Lade Daten...')
var total_count = 0;
d3.tsv('highlights.csv').then((data) => {
    d3.select('tbody')
      .selectAll('tr')
      .data(data)
      .enter()
      .append('tr')
      .style('visibility', 'visible')
      .attr('name', (row) => {return row.name;})
      .html(row_to_html_string)
      .transition()
      .on('end', (_, i) => {
        total_count = Math.max(total_count, i);
        d3.select('#status').text(total_count + ' Einträge')
      });
});

var timer = null;
d3.select('input').on('input', (e) => {
    clearTimeout(timer);
    timer = setTimeout(function () {
        d3.select('#status').text('Lade Daten...')
        d3.select('tbody').style('visibility', 'collapse');
        d3.select('input').attr('disabled', true);

        var visibles = 0;
        d3.select('tbody')
          .selectAll('tr')
          .transition()
          .style('visibility', (tr) => {
            if (tr.name.toLowerCase().includes(d3.select('input').property('value').toLowerCase())) {
                visibles += 1; // is that atomic?
                return 'visible';
            } else {
                return 'collapse';
            }
          })
          .on('end', (tr, i) => {
            if (i == total_count) {
                d3.select('tbody').style('visibility', 'visible');
                d3.select('input').attr('disabled', null);
                d3.select('#status').text(visibles + ' Einträge')
            }
          });

    }, 400);
});


    </script>
</html>
